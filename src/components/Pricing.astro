---
import { Icon } from "astro-icon/components";

const planNames = ["Free", "Starter", "Pro", "Enterprise"] as const;
type PlanName = (typeof planNames)[number];
type FeatureValue = string | boolean;
type FeatureMap = Partial<Record<PlanName, FeatureValue>>;

const coreFeatures = [
  "Workspace organization",
  "AI agent management",
  "Document management",
  "Conversation attachments",
  "Agent memory system",
  "Custom summarization prompts",
  "Agent schedules",
  "Web search & content extraction tools",
  "Tool integration via MCP servers",
  "Built-in tools (document search, memory search, web search, web fetch, email, notifications, delegation)",
  "Google Workspace integrations",
  "Additional MCP integrations (GitHub, Slack, Linear, HubSpot, PostHog, Salesforce, Notion, Shopify, Intercom, Todoist, Zendesk, Stripe)",
  "Cost management & billing",
  "Usage analytics & monitoring",
  "Evaluation & quality control",
  "Flexible authentication",
  "Streaming support",
  "Webhook API",
  "Chat platform bot integrations (Slack, Discord)",
  "Notification channels",
  "Team collaboration (workspace permissions)",
  "REST API + OpenAPI documentation",
];

const cappedFeatures: { label: string; values: FeatureMap }[] = [
  {
    label: "Workspaces",
    values: {
      Free: "1 Workspace",
      Starter: "1 Workspace",
      Pro: "5 Workspaces",
      Enterprise: "Unlimited Workspaces",
    },
  },
  {
    label: "Agents",
    values: {
      Free: "1 Agent",
      Starter: "5 Agents",
      Pro: "50 Agents",
      Enterprise: "Unlimited Agents",
    },
  },
  {
    label: "Documents",
    values: {
      Free: "10 Documents (1 MB total)",
      Starter: "100 Documents (10 MB total)",
      Pro: "1,000 Documents (100 MB total)",
      Enterprise: "Unlimited Documents",
    },
  },
  {
    label: "AI messages per day",
    values: {
      Free: "50 AI messages per day",
      Starter: "2,500 AI messages per day",
      Pro: "25,000 AI messages per day",
      Enterprise: "Unlimited AI messages per day",
    },
  },
  {
    label: "Web searches per day",
    values: {
      Free: "10 free web searches/day",
      Starter: "10 free web searches/day",
      Pro: "10 free web searches/day",
      Enterprise: "10 free web searches/day",
    },
  },
  {
    label: "App connections",
    values: {
      Free: "2 app connections",
      Starter: "10 app connections",
      Pro: "50 app connections",
      Enterprise: "Unlimited app connections",
    },
  },
  {
    label: "Agent limits (daily/monthly/yearly)",
    values: {
      Free: true,
      Starter: true,
      Pro: true,
      Enterprise: true,
    },
  },
  {
    label: "Memory retention",
    values: {
      Free: "48h detailed memory, 30d summaries",
      Starter: "Longer memory history",
      Pro: "240h detailed memory, 120d summaries",
    },
  },
  {
    label: "Managers (shared access)",
    values: {
      Pro: "Unlimited managers (shared access)",
    },
  },
  {
    label: "Support",
    values: {
      Starter: "Email Support",
      Pro: "Priority Support",
      Enterprise: "Dedicated Support",
    },
  },
  {
    label: "SLA Guarantee",
    values: {
      Enterprise: "SLA Guarantee",
    },
  },
  {
    label: "No credit card required",
    values: {
      Free: true,
    },
  },
];

const plans = [
  {
    name: "Free",
    price: "$0",
    period: "",
    description:
      "Perfect for evaluating Helpmaton with free access.",
    icon: "heroicons:gift",
    badge: "Free forever",
    cta: "Get Started",
    popular: false,
  },
  {
    name: "Starter",
    price: "$29",
    period: "/month",
    description:
      "For individuals and small projects. Create up to 5 agents and manage one workspace.",
    icon: "heroicons:sparkles",
    cta: "Start Trial",
    popular: false,
  },
  {
    name: "Pro",
    price: "$99",
    period: "/month",
    description:
      "For teams that need multiple workspaces and more agents. Includes unlimited team members.",
    icon: "heroicons:rocket-launch",
    cta: "Start Trial",
    popular: true,
  },
  {
    name: "Enterprise",
    price: "Custom",
    period: "",
    description:
      "For organizations that need custom limits, dedicated support, and SLA guarantees.",
    icon: "heroicons:building-office",
    cta: "Contact Sales",
    popular: false,
  },
];
---

<section
  id="pricing"
  class="section-dark p-8 py-20 relative overflow-hidden"
>
  <div class="max-w-6xl mx-auto relative z-10">
    <div class="mb-16 text-center">
      <p class="section-label font-mono mb-2">Pricing</p>
      <div class="section-divider mb-4" aria-hidden="true" />
      <h2 class="text-display-2 font-display text-neutral-100 mb-4">
        Choose the plan that <span class="text-neon-cyan">works</span> for you
      </h2>
      <p class="text-lg text-neutral-400 max-w-2xl mx-auto mb-2">
        Start free or choose a paid plan when you need more scale.
      </p>
      <p class="text-sm text-neutral-500">
        Cancel anytime. No long-term contracts.
      </p>
      <p class="text-sm text-neutral-500 mt-3">
        Have questions?{" "}
        <a href="/faq" class="text-neon-cyan hover:text-neon-cyan-dim underline">
          Visit the FAQ
        </a>
      </p>
    </div>

    <div class="card-cyber border-neon-cyan/30 p-6 mb-12">
      <h3 class="text-lg font-semibold text-neutral-100 mb-3">
        What's Included
      </h3>
      <p class="text-sm text-neutral-400 mb-3">
        Your subscription covers the Helpmaton platform. AI provider usage is
        separate.
      </p>
      <ul class="list-disc list-inside space-y-2 text-sm text-neutral-400 ml-4">
        <li>
          <strong>Platform services:</strong> hosting, workspaces, teams, document
          search, usage tracking, memory, and core features
        </li>
        <li>
          <strong>AI usage options:</strong> use your own API keys or purchase
          credits through Helpmaton
        </li>
        <li>
          <strong>Web search:</strong> 10 free searches per 24 hours, then $0.008
          each
        </li>
        <li>
          <strong>Subscription sharing:</strong> Pro includes unlimited managers
        </li>
        <li>
          <strong>Memory retention:</strong> Free keeps 48h detailed memory and 30d
          summaries; Pro keeps 240h and 120d
        </li>
        <li>
          <strong>Budget control:</strong> agent-level caps keep costs predictable
        </li>
      </ul>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      {
        plans.map((plan) => (
          <div
            class={`p-8 rounded-xl transition-all hover:scale-[1.02] card-tilt ${
              plan.popular
                ? "card-cyber border-2 border-neon-cyan shadow-neon-cyan-lg relative overflow-hidden"
                : "card-cyber"
            }`}
          >
            {plan.popular && (
              <div class="absolute top-0 right-0 w-32 h-32 bg-neon-cyan/20 rounded-full blur-2xl" aria-hidden="true" />
            )}
            <div class="relative z-10 min-h-[220px] flex flex-col">
              <div class="text-center mb-4 min-h-[28px]">
                {plan.popular ? (
                  <span class="inline-block bg-neon-cyan/20 text-neon-cyan px-4 py-1 font-bold text-sm rounded-full font-mono border border-neon-cyan/50 shadow-neon-cyan">
                    ⭐ Most Popular
                  </span>
                ) : (
                  <span class="inline-block px-4 py-1 text-sm opacity-0 select-none">
                    Most Popular
                  </span>
                )}
              </div>
              <div class="flex items-center justify-center gap-2 mb-3">
                <span class="transform hover:scale-110 transition-transform">
                  <Icon
                    name={plan.icon}
                    class={`w-10 h-10 ${plan.popular ? "text-neon-cyan" : "text-neon-cyan"}`}
                    aria-hidden="true"
                  />
                </span>
                <h3 class="text-2xl font-bold text-neutral-100">
                  {plan.name}
                </h3>
              </div>
              <div class="text-center mb-3 min-h-[24px]">
                {plan.badge ? (
                  <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full bg-neon-magenta/20 text-neon-magenta font-mono border border-neon-magenta/30">
                    {plan.badge}
                  </span>
                ) : (
                  <span class="inline-block px-3 py-1 text-xs opacity-0 select-none">
                    Badge
                  </span>
                )}
              </div>
              <div class="mb-4">
                <span class="text-5xl font-bold font-mono text-neutral-100 tabular-nums">
                  {plan.price}
                </span>
                <span class="text-base text-neutral-400 font-mono">
                  {plan.period}
                </span>
              </div>
              <p class="text-sm mb-6 text-neutral-400">
                {plan.description}
              </p>
            </div>
            <ul class="grid gap-y-3 mb-6 relative z-10">
              {cappedFeatures.map((feature) => {
                const planName = plan.name as PlanName;
                const value = feature.values[planName];
                const isAvailable = Boolean(value);
                const showValue = value !== true && value !== undefined;
                const isCreditCardFeature = feature.label === "No credit card required";
                const showCreditCardRequired = isCreditCardFeature && !isAvailable;
                const iconName = showCreditCardRequired
                  ? "heroicons:check"
                  : isAvailable
                    ? "heroicons:check"
                    : "heroicons:x-mark";
                return (
                <li class="grid grid-cols-[20px,1fr] items-start gap-2">
                  <Icon
                    name={iconName}
                    class={`w-5 h-5 mt-0.5 shrink-0 ${
                      isAvailable || showCreditCardRequired
                        ? "text-neon-green"
                        : "text-neutral-500"
                    }`}
                    aria-hidden="true"
                  />
                  <span class="text-sm text-neutral-400">
                    {showCreditCardRequired ? "Credit card required" : feature.label}
                    {isAvailable && showValue ? ` — ${value}` : ""}
                    {!isAvailable && !showCreditCardRequired ? " — Not included" : ""}
                  </span>
                </li>
              )})}
            </ul>
            <div class="relative z-10 mb-8">
              {plan.name === "Enterprise" ? (
                <button
                  data-open-sales-modal
                  data-source="pricing"
                  class="block w-full text-center px-6 py-3 font-bold rounded-xl transition-all cursor-pointer btn-neon-primary"
                >
                  {plan.cta}
                </button>
              ) : (
                <a
                  href="https://app.helpmaton.com"
                  data-track="get_started"
                  data-plan={plan.name}
                  class="block text-center px-6 py-3 font-bold rounded-xl transition-all btn-neon-primary"
                >
                  Get Started
                </a>
              )}
            </div>
            <div class="relative z-10 mb-8">
              <div class="text-xs font-semibold uppercase tracking-wide mb-3 text-neutral-500 font-mono">
                Included on all plans
              </div>
              <ul class="space-y-2">
                {coreFeatures.map((feature) => (
                  <li class="flex items-start gap-2">
                    <Icon
                      name="heroicons:check-badge"
                      class="w-4 h-4 mt-0.5 shrink-0 text-neon-cyan/80"
                      aria-hidden="true"
                    />
                    <span class="text-xs text-neutral-500">
                      {feature}
                    </span>
                  </li>
                ))}
              </ul>
            </div>
            {plan.name === "Enterprise" ? (
              <button
                data-open-sales-modal
                data-source="pricing"
                class="block w-full text-center px-6 py-3 font-bold rounded-xl transition-all cursor-pointer relative z-10 btn-neon-primary"
              >
                {plan.cta}
              </button>
            ) : (
              <a
                href="https://app.helpmaton.com"
                data-track="get_started"
                data-plan={plan.name}
                class="block text-center px-6 py-3 font-bold rounded-xl transition-all relative z-10 btn-neon-primary"
              >
                {plan.cta}
              </a>
            )}
          </div>
        ))
      }
    </div>
  </div>
</section>

<script>
  document.querySelectorAll('a[data-track="get_started"]').forEach((el) => {
    el.addEventListener('click', (e) => {
      const plan = (e.currentTarget as HTMLElement).getAttribute('data-plan');
      if (window.posthog) {
        window.posthog.capture('get_started_clicked', { plan: plan ?? undefined });
      }
      const href = (e.currentTarget as HTMLAnchorElement).href;
      e.preventDefault();
      setTimeout(() => { window.location.href = href; }, 150);
    });
  });
</script>
