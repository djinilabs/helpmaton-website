---
// EU cookie consent bar: show once, store in localStorage, gate analytics/marketing until consent.
---

<div id="cookie-consent-bar" class="cookie-consent-bar hidden" role="region" aria-label="Cookie consent">
  <div class="max-w-6xl mx-auto px-4 py-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <p class="text-sm text-neutral-700">
      We use cookies for essential operation (including storing your choice), analytics and marketing. See our
      <a href="/privacy" class="text-primary-600 hover:text-primary-700 font-medium underline">Privacy Statement</a>.
    </p>
    <div class="flex flex-wrap items-center gap-2">
      <button type="button" id="cookie-consent-reject" class="cookie-consent-btn cookie-consent-btn-secondary">
        Reject non-essential
      </button>
      <button type="button" id="cookie-consent-customize" class="cookie-consent-btn cookie-consent-btn-secondary" aria-expanded="false" aria-controls="cookie-consent-details">
        Customize
      </button>
      <button type="button" id="cookie-consent-accept" class="cookie-consent-btn cookie-consent-btn-primary">
        Accept all
      </button>
    </div>
  </div>
  <div id="cookie-consent-details" class="cookie-consent-details hidden border-t border-neutral-200 bg-neutral-50" role="region" aria-label="Cookie preferences">
    <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="space-y-3 text-sm">
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" id="cookie-consent-analytics" class="rounded border-neutral-300 text-primary-600 focus:ring-primary-500" />
          <span class="text-neutral-700">Analytics (PostHog) – helps us improve the site</span>
        </label>
        <label class="flex items-center gap-3 cursor-pointer">
          <input type="checkbox" id="cookie-consent-marketing" class="rounded border-neutral-300 text-primary-600 focus:ring-primary-500" />
          <span class="text-neutral-700">Marketing (Google Ads, LinkedIn) – used for campaign measurement</span>
        </label>
      </div>
      <button type="button" id="cookie-consent-save" class="cookie-consent-btn cookie-consent-btn-primary mt-4">
        Save preferences
      </button>
    </div>
  </div>
</div>

<style>
  .cookie-consent-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 9999;
    background: white;
    border-top: 1px solid #e7e5e4;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.06);
    animation: cookie-consent-slide-up 0.3s ease-out;
  }
  @media (prefers-reduced-motion: reduce) {
    .cookie-consent-bar {
      animation: none;
    }
  }
  .cookie-consent-bar.hidden {
    display: none !important;
  }
  .cookie-consent-details.hidden {
    display: none !important;
  }
  .cookie-consent-btn {
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.15s, color 0.15s;
  }
  .cookie-consent-btn-primary {
    background: #0d9488;
    color: white;
    border: none;
  }
  .cookie-consent-btn-primary:hover {
    background: #0f766e;
  }
  .cookie-consent-btn-secondary {
    background: transparent;
    color: #57534e;
    border: 1px solid #d6d3d1;
  }
  .cookie-consent-btn-secondary:hover {
    background: #f5f5f4;
    border-color: #a8a29e;
  }
  @keyframes cookie-consent-slide-up {
    from {
      transform: translateY(100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
</style>

<script>
  const STORAGE_KEY = 'helpmaton_cookie_consent';
  const CONSENT_VERSION = 1;

  function getConsent(): { version: number; necessary: boolean; analytics: boolean; marketing: boolean; ts: string } | null {
    if (typeof localStorage === 'undefined') return null;
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      const data = JSON.parse(raw);
      return data && data.version === CONSENT_VERSION ? data : null;
    } catch {
      return null;
    }
  }

  function setConsent(analytics: boolean, marketing: boolean): void {
    if (typeof localStorage === 'undefined') return;
    const data = {
      version: CONSENT_VERSION,
      necessary: true,
      analytics,
      marketing,
      ts: new Date().toISOString(),
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function loadPostHog(): void {
    if (typeof document === 'undefined' || (window as unknown as { posthog?: unknown }).posthog) return;
    const script = document.createElement('script');
    script.type = 'text/javascript';
    script.textContent = "!function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(\".\");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement(\"script\")).type=\"text/javascript\",p.crossOrigin=\"anonymous\",p.async=!0,p.src=s.api_host+\"/static/array.js\",(r=t.getElementsByTagName(\"script\")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a=\"posthog\",u.people=u.people||[],u.toString=function(t){var e=\"posthog\";return\"posthog\"!==a&&(e+=\".\"+a),t||(e+=\" (stub)\"),e},u.people.toString=function(){return u.toString(1)+\".people (stub)\"},o=\"capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys getNextSurveyStep onSessionId\".split(\" \"),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);posthog.init('phc_L4NZ7thapgbLJTtu445jptB59wPiiG4y1EHyGXreNKZ',{api_host:'https://eu.i.posthog.com',defaults:'2025-11-30'});";
    document.head?.appendChild(script);
  }

  function loadLinkedIn(): void {
    if (typeof document === 'undefined') return;
    const win = window as unknown as Record<string, unknown>;
    win._linkedin_data_partner_ids = (win._linkedin_data_partner_ids as string[]) || [];
    (win._linkedin_data_partner_ids as string[]).push('8635162');
    if (!win.lintrk) {
      const q: unknown[] = [];
      win.lintrk = function (a: unknown, b?: unknown) {
        q.push([a, b]);
      };
      (win.lintrk as Record<string, unknown>).q = q;
    }
    const s = document.getElementsByTagName('script')[0];
    const b = document.createElement('script');
    b.type = 'text/javascript';
    b.async = true;
    b.src = 'https://snap.licdn.com/li.lms-analytics/insight.min.js';
    s?.parentNode?.insertBefore(b, s);
  }

  function updateGoogleConsent(analytics: boolean, marketing: boolean): void {
    const gtag = (window as unknown as { gtag?: (...args: unknown[]) => void }).gtag;
    if (typeof gtag !== 'function') return;
    gtag('consent', 'update', {
      ad_storage: marketing ? 'granted' : 'denied',
      ad_user_data: marketing ? 'granted' : 'denied',
      ad_personalization: marketing ? 'granted' : 'denied',
      analytics_storage: analytics ? 'granted' : 'denied',
    });
  }

  function applyConsent(analytics: boolean, marketing: boolean): void {
    if (analytics) loadPostHog();
    if (marketing) loadLinkedIn();
    updateGoogleConsent(analytics, marketing);
  }

  function hideBar(): void {
    const bar = document.getElementById('cookie-consent-bar');
    if (bar) bar.classList.add('hidden');
  }

  function showBar(): void {
    const bar = document.getElementById('cookie-consent-bar');
    if (bar) bar.classList.remove('hidden');
  }

  document.addEventListener('DOMContentLoaded', () => {
    const consent = getConsent();
    if (consent) {
      hideBar();
      return;
    }
    showBar();
    const firstFocusable = document.getElementById('cookie-consent-reject');
    if (firstFocusable && typeof requestAnimationFrame !== 'undefined') {
      requestAnimationFrame(() => { firstFocusable.focus({ preventScroll: true }); });
    }

    const bar = document.getElementById('cookie-consent-bar');
    const details = document.getElementById('cookie-consent-details');
    const acceptBtn = document.getElementById('cookie-consent-accept');
    const rejectBtn = document.getElementById('cookie-consent-reject');
    const customizeBtn = document.getElementById('cookie-consent-customize');
    const saveBtn = document.getElementById('cookie-consent-save');
    const analyticsCheck = document.getElementById('cookie-consent-analytics') as HTMLInputElement | null;
    const marketingCheck = document.getElementById('cookie-consent-marketing') as HTMLInputElement | null;

    function setCustomizeExpanded(expanded: boolean): void {
      customizeBtn?.setAttribute('aria-expanded', String(expanded));
    }

    acceptBtn?.addEventListener('click', () => {
      setConsent(true, true);
      applyConsent(true, true);
      hideBar();
    });

    rejectBtn?.addEventListener('click', () => {
      setConsent(false, false);
      updateGoogleConsent(false, false);
      hideBar();
    });

    customizeBtn?.addEventListener('click', () => {
      details?.classList.toggle('hidden');
      setCustomizeExpanded(!details?.classList.contains('hidden'));
    });

    saveBtn?.addEventListener('click', () => {
      const analytics = analyticsCheck?.checked ?? false;
      const marketing = marketingCheck?.checked ?? false;
      setConsent(analytics, marketing);
      applyConsent(analytics, marketing);
      if (details) details.classList.add('hidden');
      setCustomizeExpanded(false);
      hideBar();
    });
  });
</script>
